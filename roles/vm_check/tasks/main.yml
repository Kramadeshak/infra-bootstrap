---
- name: Ensure libvirt service is installed
  package:
    name: libvirt
    state: present

- name: Ensure libvirt service is enabled and running
  service:
    name: libvirtd
    state: started
    enabled: true

- name: Ensure KVM device exists
  stat:
    path: /dev/kvm
  register: kvm_device

- name: Fail if KVM is not available
  fail:
    msg: "/dev/kvm not found. Hardware virtualization is not available."
  when: not kvm_device.stat.exists

- name: Ensure libvirt images directory exists
  file:
    path: /var/lib/libvirt/images
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure cloud-init is installed
  package:
    name: cloud-init
    state: present
